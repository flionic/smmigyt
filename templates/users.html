{% extends 'layout/main.html' %}
{% block main %}
    {% call section() %}
        <form id="settings-users" class="col s12 m10 offset-m1">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Пользователи</span>
                    {%- for u in users -%}
                        <div class="row no-mar-bot user">
                            <div class="input-field col s12" style="margin: 0">
                                <span>ID: </span><span class="user-id">{{ u.id }}</span>
                            </div>
                            <div class="input-field col s12 m6">
                                <input class="user-email validate" type="text" value="{{ u.email }}" required>
                                <label>Логин</label>
                            </div>
                            <div class="input-field col s12 m2">
                                <input class="user-balance validate" type="number" step="0.01" value="{{ u.balance }}"
                                       style="width: 90%;" required>
                                <span>₽</span>
                                <label>Баланс</label>
                            </div>
                        </div>
                    {%- endfor -%}
                </div>
                <div class="card-action">
                    <div class="row">
                        <div class="col s12 right-align">
                            <button class="btn waves-effect waves-light green btn-action"
                                    type="submit" name="submit">Сохранить<i class="fas fa-save right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    {% endcall %}
{% endblock %}
{% block scripts %}
    <script type="text/javascript">
        $(document).ready(function () {
            $('.sending').hide();
            $('select').formSelect();
            $('#settings-users').submit(function (event) {
                event.preventDefault();
                var pl = $(this).find('.sending'), btn = $(this).find('.btn-action'), fid = $(this).attr('id'), params = [];
                pl.addClass('active').show();
                btn.fadeOut('fast');
                $('.user').each(function (i, elem) {
                    params.push({
                        "id": $(this).find('.user-id').text(),
                        "email": $(this).find('.user-email').val(),
                        "balance": $(this).find('.user-balance').val()
                    });
                });
                console.log(JSON.stringify(params));
                $.ajax({
                    url: '/ajax/save/' + $(this).attr('id'),
                    type: "POST",
                    data: JSON.stringify(params),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        M.toast({html: ({0: 'Ошибка', 1: 'Сохранено'})[data['response']], displayLength: 5 * 1000});
                        btn.fadeIn('fast');
                        pl.hide().removeClass('active');
                    }
                });
            });
        });
    </script>
{% endblock %}